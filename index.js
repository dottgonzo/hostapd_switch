var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var Promise = require("bluebird");
var pathExists = require("path-exists");
var dnsmasqconf = require("dnsmasq-conf");
var merge = require("json-add");
var testinternet = require('promise-test-connection');
var wpamanager = require('wpasupplicant-manager');
var netw = require("netw");
var verb = require('verbo');
var exec = require('promised-exec');
var hostapdconf = require("hostapdjs");
function testconn(d, testint) {
    return new Promise(function (resolve, reject) {
        netw().then(function (n) {
            var dev = false;
            var ip = false;
            var netw;
            for (var ns = 0; ns < n.networks.length; ns++) {
                if (n.networks[ns].interface == d) {
                    netw = n.networks[ns];
                    dev = d;
                    if (n.networks[ns].ip) {
                        ip = n.networks[ns].ip;
                    }
                }
            }
            if (!dev) {
                reject('no interface');
            }
            else if (!ip) {
                reject(dev + ' can\'t get an ip address');
            }
            else {
                netw.mode = "client";
                if (testint) {
                    testinternet().then(function (a) {
                        if (a.ip) {
                            resolve(true);
                        }
                        else {
                            resolve(true);
                        }
                    }).catch(function (err) {
                        reject(err);
                    });
                }
                else {
                    console.log("warn no internet");
                    resolve(true);
                }
            }
        }).catch(function (err) {
            reject('netw' + err);
        });
    });
}
;
;
;
;
;
;
var config = {
    interface: "wlan0",
    wpasupplicant_path: "/etc/wpa_supplicant/wpa_supplicant.conf",
    redirect: true,
    hostapd: { interface: "wlan0", wpa_passphrase: false, ssid: "hapd111", fileconf: "/etc/default/hostapd" },
    dnsmasq: { interface: "wlan0" },
    init: false
};
;
module.exports = (function (_super) {
    __extends(HostapdSwitch, _super);
    function HostapdSwitch(options, init) {
        merge(config, options);
        if (!pathExists.sync('/etc/default/hostapd')) {
            throw Error('no default conf file was founded for hostapd');
        }
        if (!config.hostapd.ssid) {
            throw Error('No ssid was provided');
        }
        if (!config.hostapd.wpa_passphrase) {
            throw Error('No wpa_passphrase was provided');
        }
        this.config = config;
        _super.call(this, config.wpasupplicant_path);
        this.dnsmasq = new dnsmasqconf(config.dnsmasq);
        if (init) {
            hostapdconf(config.hostapd).then(function () {
                console.log('hostapd is now configured');
            });
        }
        ;
    }
    ;
    HostapdSwitch.prototype.host = function (e) {
        var dnsmasq = this.dnsmasq;
        var hostIp = dnsmasq.hostIp;
        var cmd = 'pkill wpa_supplicant ; ifconfig ' + this.config.interface + ' up && systemctl restart hostapd ; systemctl restart dnsmasq && ifconfig ' + this.config.interface + ' ' + hostIp + ' netmask 255.255.255.0 up && sleep 5';
        return new Promise(function (resolve, reject) {
            dnsmasq.setmode('host').then(function () {
                exec(cmd).then(function () {
                    exec('iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination ' + hostIp + ':80 && iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to-destination ' + hostIp + ':80').then(function () {
                        resolve(true);
                    }).catch(function (err) {
                        verb(err, 'error', 'hostapd_switch ipfilter host switch');
                    });
                }).catch(function (err) {
                    verb(err, 'error', 'hostapd_switch executing host switch');
                });
            }).catch(function (err) {
                verb(err, 'error', 'hostapd_switch executing dnsmasq host switch');
            });
        });
    };
    ;
    HostapdSwitch.prototype.ap = function (e) {
        var dnsmasq = this.dnsmasq;
        var hostIp = dnsmasq.hostIp;
        var cmd = 'pkill wpa_supplicant ; ifconfig ' + this.config.interface + ' up  && systemctl restart hostapd ; systemctl restart dnsmasq && ifconfig ' + this.config.interface + ' ' + hostIp + ' netmask 255.255.255.0 up && for i in $( iptables -t nat --line-numbers -L | grep ^[0-9] | awk \'{ print $1 }\' | tac ); do iptables -t nat -D PREROUTING $i; done';
        return new Promise(function (resolve, reject) {
            dnsmasq.ap().then(function () {
                exec(cmd).then(function () {
                    resolve(true);
                }).catch(function (err) {
                    verb(err, 'error', 'hostapd_switch executing ap switch');
                });
            }).catch(function (err) {
                verb(err, 'error', 'hostapd_switch executing dnsmasq before ap switch');
            });
        });
    };
    ;
    HostapdSwitch.prototype.client = function (testnetw, testint) {
        var dev = this.config.interface;
        var cmd = 'ifconfig ' + dev + ' down && sleep 2 ; pkill wpa_supplicant ;  dhclient -r ' + dev + ' ; systemctl stop hostapd ; systemctl stop dnsmasq ; sleep 2; ifconfig ' + dev + ' up && wpa_supplicant -B -i ' + dev + ' -c ' + this.config.wpasupplicant_path + ' -D wext && dhclient ' + dev + ' && for i in $( iptables -t nat --line-numbers -L | grep ^[0-9] | awk \'{ print $1 }\' | tac ); do iptables -t nat -D PREROUTING $i; done';
        return new Promise(function (resolve, reject) {
            netw().then(function (n) {
                exec(cmd).then(function () {
                    if (testnetw) {
                        testconn(dev, testint).then(function (answer) {
                            resolve(answer);
                        }).catch(function (err) {
                            reject(err);
                        });
                    }
                    else {
                        resolve(true);
                    }
                }).catch(function (err) {
                    verb(err, 'warn', 'hostapd_switch exec');
                    if (testnetw) {
                        testconn(dev, testint).then(function (answer) {
                            resolve(answer);
                        }).catch(function (err) {
                            reject(err);
                        });
                    }
                    else {
                        resolve(true);
                    }
                });
            }).catch(function (err) {
                verb(err, 'error', 'hostapd_switch conf error');
            });
        });
    };
    ;
    return HostapdSwitch;
})(wpamanager);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbInRlc3Rjb25uIiwiY29uc3RydWN0b3IiLCJob3N0IiwiYXAiLCJjbGllbnQiXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFDcEMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxXQUFXLFdBQU0sY0FBYyxDQUFDLENBQUE7QUFDNUMsSUFBTyxLQUFLLFdBQVcsVUFBVSxDQUFDLENBQUM7QUFDbkMsSUFBTyxZQUFZLFdBQVcseUJBQXlCLENBQUMsQ0FBQztBQUN6RCxJQUFPLFVBQVUsV0FBVyx1QkFBdUIsQ0FBQyxDQUFDO0FBRXJELElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDNUIsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3BDLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUd2QyxrQkFBa0IsQ0FBUyxFQUFFLE9BQWlCO0lBRTFDQSxNQUFNQSxDQUFDQSxJQUFJQSxPQUFPQSxDQUFVQSxVQUFTQSxPQUFPQSxFQUFFQSxNQUFNQTtRQUNoRCxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBUyxDQUFDO1lBQ2xCLElBQUksR0FBRyxHQUFRLEtBQUssQ0FBQztZQUNyQixJQUFJLEVBQUUsR0FBUSxLQUFLLENBQUM7WUFDcEIsSUFBSSxJQUFzQixDQUFDO1lBQzNCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDO2dCQUM1QyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMs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VSxDQTRHOUMsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcbmltcG9ydCAqIGFzIHBhdGhFeGlzdHMgZnJvbSBcInBhdGgtZXhpc3RzXCI7XG5pbXBvcnQgKiBhcyBkbnNtYXNxY29uZiBmcm9tIFwiZG5zbWFzcS1jb25mXCI7XG5pbXBvcnQgbWVyZ2UgPSByZXF1aXJlKFwianNvbi1hZGRcIik7XG5pbXBvcnQgdGVzdGludGVybmV0ID0gcmVxdWlyZSgncHJvbWlzZS10ZXN0LWNvbm5lY3Rpb24nKTtcbmltcG9ydCB3cGFtYW5hZ2VyID0gcmVxdWlyZSgnd3Bhc3VwcGxpY2FudC1tYW5hZ2VyJyk7XG5cbmxldCBuZXR3ID0gcmVxdWlyZShcIm5ldHdcIik7XG5sZXQgdmVyYiA9IHJlcXVpcmUoJ3ZlcmJvJyk7XG5sZXQgZXhlYyA9IHJlcXVpcmUoJ3Byb21pc2VkLWV4ZWMnKTtcbmxldCBob3N0YXBkY29uZiA9IHJlcXVpcmUoXCJob3N0YXBkanNcIik7XG5cblxuZnVuY3Rpb24gdGVzdGNvbm4oZDogc3RyaW5nLCB0ZXN0aW50PzogYm9vbGVhbikge1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBuZXR3KCkudGhlbihmdW5jdGlvbihuKSB7XG4gICAgICAgICAgICBsZXQgZGV2OiBhbnkgPSBmYWxzZTtcbiAgICAgICAgICAgIGxldCBpcDogYW55ID0gZmFsc2U7XG4gICAgICAgICAgICBsZXQgbmV0dzogeyBtb2RlOiBzdHJpbmcgfTtcbiAgICAgICAgICAgIGZvciAobGV0IG5zID0gMDsgbnMgPCBuLm5ldHdvcmtzLmxlbmd0aDsgbnMrKykge1xuICAgICAgICAgICAgICAgIGlmIChuLm5ldHdvcmtzW25zXS5pbnRlcmZhY2UgPT0gZCkge1xuICAgICAgICAgICAgICAgICAgICBuZXR3ID0gbi5uZXR3b3Jrc1tuc107XG4gICAgICAgICAgICAgICAgICAgIGRldiA9IGQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChuLm5ldHdvcmtzW25zXS5pcCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXAgPSBuLm5ldHdvcmtzW25zXS5pcFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vICAgICAgaWYgKG4ubmV0d29ya3NbbnNdLmdhdGV3YXkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICBndyA9IG4ubmV0d29ya3NbbnNdLmdhdGV3YXlcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghZGV2KSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KCdubyBpbnRlcmZhY2UnKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlwKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGRldiArICcgY2FuXFwndCBnZXQgYW4gaXAgYWRkcmVzcycpO1xuICAgICAgICAgICAgICAgIC8vICB9IGVsc2UgaWYgKCFndykge1xuICAgICAgICAgICAgICAgIC8vICAgICByZWplY3QoZGV2ICsgJyBoYXMgbm8gZ2F0ZXdheScpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5ldHcubW9kZSA9IFwiY2xpZW50XCI7XG4gICAgICAgICAgICAgICAgaWYgKHRlc3RpbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGVzdGludGVybmV0KCkudGhlbihmdW5jdGlvbihhOiB7IGlwPzogYW55IH0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhLmlwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIndhcm4gbm8gaW50ZXJuZXRcIik7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgcmVqZWN0KCduZXR3JyArIGVycik7XG4gICAgICAgIH0pXG4gICAgfSlcblxufVxuXG5pbnRlcmZhY2UgSUhvc3RhcGQge1xuICAgIGludGVyZmFjZTogc3RyaW5nO1xuICAgIHNzaWQ6IHN0cmluZztcbiAgICB3cGFfcGFzc3BocmFzZTogYW55O1xuICAgICAgICBmaWxlY29uZjpzdHJpbmc7XG59O1xuXG5pbnRlcmZhY2UgSUhvc3RhcGRDZiB7XG4gICAgZHJpdmVyPzogc3RyaW5nO1xuICAgIHNzaWQ/OiBzdHJpbmc7XG4gICAgZmlsZWNvbmY/OnN0cmluZztcbiAgICB3cGFfcGFzc3BocmFzZT86c3RyaW5nO1xufTtcblxuaW50ZXJmYWNlIElEbnNtYXNxIHtcbiAgICBpbnRlcmZhY2U6IHN0cmluZztcbn07XG5cbmludGVyZmFjZSBJRG5zbWFzcUNmIHtcbiAgICBpbnRlcmZhY2U/OiBzdHJpbmc7XG59O1xuXG5pbnRlcmZhY2UgSUNsYXNzT3B0IHtcbiAgICBpbnRlcmZhY2U/OiBzdHJpbmc7XG4gICAgd3Bhc3VwcGxpY2FudF9wYXRoPzogc3RyaW5nO1xuICAgIGhvc3RhcGQ/OiBJSG9zdGFwZENmO1xuICAgIHJlZGlyZWN0PzogYm9vbGVhbjtcbiAgICBkbnNtYXNxPzogSURuc21hc3FDZjtcbn07XG5cbmludGVyZmFjZSBJQ2xhc3NDb25mIHtcbiAgICBpbnRlcmZhY2U6IHN0cmluZztcbiAgICB3cGFzdXBwbGljYW50X3BhdGg6IHN0cmluZztcbiAgICBob3N0YXBkOiBJSG9zdGFwZDtcbiAgICBkbnNtYXNxOiBJRG5zbWFzcTtcbiAgICBpbml0OiBib29sZWFuO1xuICAgIHJlZGlyZWN0OiBib29sZWFuO1xufTtcblxuXG5sZXQgY29uZmlnOiBJQ2xhc3NDb25mID0ge1xuICAgIGludGVyZmFjZTogXCJ3bGFuMFwiLFxuICAgIHdwYXN1cHBsaWNhbnRfcGF0aDogXCIvZXRjL3dwYV9zdXBwbGljYW50L3dwYV9zdXBwbGljYW50LmNvbmZcIixcbiAgICByZWRpcmVjdDogdHJ1ZSxcbiAgICBob3N0YXBkOiB7IGludGVyZmFjZTogXCJ3bGFuMFwiLCB3cGFfcGFzc3BocmFzZTogZmFsc2UsIHNzaWQ6IFwiaGFwZDExMVwiLCBmaWxlY29uZjpcIi9ldGMvZGVmYXVsdC9ob3N0YXBkXCIgfSxcbiAgICBkbnNtYXNxOiB7IGludGVyZmFjZTogXCJ3bGFuMFwiIH0sXG4gICAgaW5pdDogZmFsc2Vcbn07XG5cbmludGVyZmFjZSBJRG5zTW9kZXMge1xuICAgIGFwOiBJRG5zTW9kZTtcbiAgICBsaW5rOiBJRG5zTW9kZTtcbiAgICBob3N0OiBJRG5zTW9kZVxufTtcblxuaW50ZXJmYWNlIElEbnNNb2RlIHtcbiAgICBub3Jlc29sdjogYm9vbGVhbixcbiAgICBkbnM6IFtzdHJpbmddLFxuICAgIGRoY3A6IHtcbiAgICAgICAgc3RvcDogbnVtYmVyO1xuICAgICAgICBzdGFydDogbnVtYmVyO1xuICAgICAgICBsZWFzZTogc3RyaW5nO1xuICAgIH07XG4gICAgaG9zdElwOiBzdHJpbmcsXG4gICAgdGVzdDogYm9vbGVhbixcbiAgICBpbnRlcmZhY2U6IGFueSxcbiAgICBhZGRyZXNzPzogc3RyaW5nXG59XG5cblxuXG5pbnRlcmZhY2UgSURucyB7XG4gICAgICAgIG1vZGVzOiBJRG5zTW9kZXM7XG4gICAgbW9kZT86IHN0cmluZztcbiAgICBwYXRoOnN0cmluZztcbiAgICAgICAgaW50ZXJmYWNlOiBhbnk7XG4gICAgdGVzdDogYm9vbGVhbjtcbiAgICBkaGNwOiB7XG4gICAgICAgIHN0b3A6IG51bWJlcjtcbiAgICAgICAgc3RhcnQ6IG51bWJlcjtcbiAgICAgICAgbGVhc2U6IHN0cmluZztcbiAgICB9O1xuICAgIGRuczogW3N0cmluZ107XG4gICAgaG9zdElwOiBzdHJpbmc7XG4gICAgYXA6RnVuY3Rpb247XG4gICAgaG9zdDpGdW5jdGlvbjtcbiAgICBsaW5rOkZ1bmN0aW9uO1xuICAgIHNldG1vZGUoc3RyaW5nKTtcbn1cblxuXG5leHBvcnQgPSBjbGFzcyBIb3N0YXBkU3dpdGNoIGV4dGVuZHMgd3BhbWFuYWdlciB7XG4gICAgY29uZmlnOiBJQ2xhc3NDb25mO1xuICAgIGRuc21hc3E6IElEbnM7XG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogSUNsYXNzT3B0LCBpbml0PzogYm9vbGVhbikge1xuICAgICAgICBtZXJnZShjb25maWcsIG9wdGlvbnMpXG5cbiAgICAgICAgaWYgKCFwYXRoRXhpc3RzLnN5bmMoJy9ldGMvZGVmYXVsdC9ob3N0YXBkJykpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdubyBkZWZhdWx0IGNvbmYgZmlsZSB3YXMgZm91bmRlZCBmb3IgaG9zdGFwZCcpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjb25maWcuaG9zdGFwZC5zc2lkKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcignTm8gc3NpZCB3YXMgcHJvdmlkZWQnKVxuICAgICAgICB9XG4gICAgICAgIGlmICghY29uZmlnLmhvc3RhcGQud3BhX3Bhc3NwaHJhc2UpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdObyB3cGFfcGFzc3BocmFzZSB3YXMgcHJvdmlkZWQnKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuc3VwZXIoY29uZmlnLndwYXN1cHBsaWNhbnRfcGF0aClcbiAgICAgICAgdGhpcy5kbnNtYXNxID0gbmV3IGRuc21hc3Fjb25mKGNvbmZpZy5kbnNtYXNxKTtcblxuICAgICAgICBpZiAoaW5pdCkge1xuICAgICAgICAgICAgaG9zdGFwZGNvbmYoY29uZmlnLmhvc3RhcGQpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2hvc3RhcGQgaXMgbm93IGNvbmZpZ3VyZWQnKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICB9O1xuXG4gICAgaG9zdChlPzogYW55KSB7XG4gICAgICAgIGxldCBkbnNtYXNxID0gdGhpcy5kbnNtYXNxO1xuICAgICAgICBsZXQgaG9zdElwID0gZG5zbWFzcS5ob3N0SXA7XG4gICAgICAgIGxldCBjbWQgPSAncGtpbGwgd3BhX3N1cHBsaWNhbnQgOyBpZmNvbmZpZyAnICsgdGhpcy5jb25maWcuaW50ZXJmYWNlICsgJyB1cCAmJiBzeXN0ZW1jdGwgcmVzdGFydCBob3N0YXBkIDsgc3lzdGVtY3RsIHJlc3RhcnQgZG5zbWFzcSAmJiBpZmNvbmZpZyAnICsgdGhpcy5jb25maWcuaW50ZXJmYWNlICsgJyAnICsgaG9zdElwICsgJyBuZXRtYXNrIDI1NS4yNTUuMjU1LjAgdXAgJiYgc2xlZXAgNSc7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxib29sZWFuPihmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgIGRuc21hc3Euc2V0bW9kZSgnaG9zdCcpLnRoZW4oZnVuY3Rpb24oKSB7XG5cbiAgICAgICAgICAgICAgICBleGVjKGNtZCkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgZXhlYygnaXB0YWJsZXMgLXQgbmF0IC1BIFBSRVJPVVRJTkcgLXAgdGNwIC0tZHBvcnQgODAgLWogRE5BVCAtLXRvLWRlc3RpbmF0aW9uICcgKyBob3N0SXAgKyAnOjgwICYmIGlwdGFibGVzIC10IG5hdCAtQSBQUkVST1VUSU5HIC1wIHRjcCAtLWRwb3J0IDQ0MyAtaiBETkFUIC0tdG8tZGVzdGluYXRpb24gJyArIGhvc3RJcCArICc6ODAnKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKVxuICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZlcmIoZXJyLCAnZXJyb3InLCAnaG9zdGFwZF9zd2l0Y2ggaXBmaWx0ZXIgaG9zdCBzd2l0Y2gnKVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICB2ZXJiKGVyciwgJ2Vycm9yJywgJ2hvc3RhcGRfc3dpdGNoIGV4ZWN1dGluZyBob3N0IHN3aXRjaCcpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgIHZlcmIoZXJyLCAnZXJyb3InLCAnaG9zdGFwZF9zd2l0Y2ggZXhlY3V0aW5nIGRuc21hc3EgaG9zdCBzd2l0Y2gnKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9O1xuXG5cbiAgICBhcChlPzogYW55KSB7XG4gICAgICAgIGxldCBkbnNtYXNxID0gdGhpcy5kbnNtYXNxO1xuICAgICAgICBsZXQgaG9zdElwID0gZG5zbWFzcS5ob3N0SXA7XG4gICAgICAgIGxldCBjbWQgPSAncGtpbGwgd3BhX3N1cHBsaWNhbnQgOyBpZmNvbmZpZyAnICsgdGhpcy5jb25maWcuaW50ZXJmYWNlICsgJyB1cCAgJiYgc3lzdGVtY3RsIHJlc3RhcnQgaG9zdGFwZCA7IHN5c3RlbWN0bCByZXN0YXJ0IGRuc21hc3EgJiYgaWZjb25maWcgJyArIHRoaXMuY29uZmlnLmludGVyZmFjZSArICcgJyArIGhvc3RJcCArICcgbmV0bWFzayAyNTUuMjU1LjI1NS4wIHVwICYmIGZvciBpIGluICQoIGlwdGFibGVzIC10IG5hdCAtLWxpbmUtbnVtYmVycyAtTCB8IGdyZXAgXlswLTldIHwgYXdrIFxcJ3sgcHJpbnQgJDEgfVxcJyB8IHRhYyApOyBkbyBpcHRhYmxlcyAtdCBuYXQgLUQgUFJFUk9VVElORyAkaTsgZG9uZSdcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgZG5zbWFzcS5hcCgpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgZXhlYyhjbWQpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSlcbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgdmVyYihlcnIsICdlcnJvcicsICdob3N0YXBkX3N3aXRjaCBleGVjdXRpbmcgYXAgc3dpdGNoJylcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgdmVyYihlcnIsICdlcnJvcicsICdob3N0YXBkX3N3aXRjaCBleGVjdXRpbmcgZG5zbWFzcSBiZWZvcmUgYXAgc3dpdGNoJylcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfTtcblxuICAgIGNsaWVudCh0ZXN0bmV0dz86IGJvb2xlYW4sIHRlc3RpbnQ/OiBib29sZWFuKSB7XG5cbiAgICAgICAgbGV0IGRldiA9IHRoaXMuY29uZmlnLmludGVyZmFjZTtcbiAgICAgICAgbGV0IGNtZCA9ICdpZmNvbmZpZyAnICsgZGV2ICsgJyBkb3duICYmIHNsZWVwIDIgOyBwa2lsbCB3cGFfc3VwcGxpY2FudCA7ICBkaGNsaWVudCAtciAnICsgZGV2ICsgJyA7IHN5c3RlbWN0bCBzdG9wIGhvc3RhcGQgOyBzeXN0ZW1jdGwgc3RvcCBkbnNtYXNxIDsgc2xlZXAgMjsgaWZjb25maWcgJyArIGRldiArICcgdXAgJiYgd3BhX3N1cHBsaWNhbnQgLUIgLWkgJyArIGRldiArICcgLWMgJyArIHRoaXMuY29uZmlnLndwYXN1cHBsaWNhbnRfcGF0aCArICcgLUQgd2V4dCAmJiBkaGNsaWVudCAnICsgZGV2ICsgJyAmJiBmb3IgaSBpbiAkKCBpcHRhYmxlcyAtdCBuYXQgLS1saW5lLW51bWJlcnMgLUwgfCBncmVwIF5bMC05XSB8IGF3ayBcXCd7IHByaW50ICQxIH1cXCcgfCB0YWMgKTsgZG8gaXB0YWJsZXMgLXQgbmF0IC1EIFBSRVJPVVRJTkcgJGk7IGRvbmUnO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxib29sZWFuPihmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblxuICAgICAgICAgICAgbmV0dygpLnRoZW4oZnVuY3Rpb24obikge1xuXG4gICAgICAgICAgICAgICAgICAgIGV4ZWMoY21kKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RuZXR3KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGNvbm4oZGV2LCB0ZXN0aW50KS50aGVuKGZ1bmN0aW9uKGFuc3dlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGFuc3dlcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmVyYihlcnIsICd3YXJuJywgJ2hvc3RhcGRfc3dpdGNoIGV4ZWMnKVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RuZXR3KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGNvbm4oZGV2LCB0ZXN0aW50KS50aGVuKGZ1bmN0aW9uKGFuc3dlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGFuc3dlcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgIHZlcmIoZXJyLCAnZXJyb3InLCAnaG9zdGFwZF9zd2l0Y2ggY29uZiBlcnJvcicpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuXG4gICAgfTtcblxuXG5cbn1cblxuXG5cblxuXG5cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
