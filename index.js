var Promise = require("bluebird");
var pathExists = require("path-exists");
var dnsmasqconf = require("dnsmasq-conf");
var merge = require("json-add");
var testinternet = require('promise-test-connection');
var netw = require("netw");
var verb = require('verbo');
var exec = require('promised-exec');
var hostapdconf = require("hostapdjs");
function testconn(d, testint) {
    return new Promise(function (resolve, reject) {
        netw().then(function (n) {
            var dev = false;
            var ip = false;
            var netw;
            for (var ns = 0; ns < n.networks.length; ns++) {
                if (n.networks[ns].interface == d) {
                    netw = n.networks[ns];
                    dev = d;
                    if (n.networks[ns].ip) {
                        ip = n.networks[ns].ip;
                    }
                }
            }
            if (!dev) {
                reject('no interface');
            }
            else if (!ip) {
                reject(dev + ' can\'t get an ip address');
            }
            else {
                netw.mode = "client";
                if (testint) {
                    testinternet().then(function (a) {
                        if (a.ip) {
                            resolve(netw);
                        }
                        else {
                            resolve(netw);
                        }
                    }).catch(function (err) {
                        reject(err);
                    });
                }
                else {
                    console.log("warn no internet");
                    resolve(netw);
                }
            }
        }).catch(function (err) {
            reject('netw' + err);
        });
    });
}
;
;
;
;
;
;
var config = {
    interface: "wlan0",
    wpasupplicant_path: "/etc/wpa_supplicant/wpa_supplicant.conf",
    redirect: true,
    hostapd: { interface: "wlan0", wpa_passphrase: false, ssid: "hapd111" },
    dnsmasq: { interface: "wlan0" },
    init: false
};
module.exports = (function () {
    function HostapdSwitch(options, init) {
        this.host = function (e) {
            var dnsmasq = this.dnsmasq;
            var hostIp = dnsmasq.host;
            var cmd = 'pkill wpa_supplicant ; ifconfig ' + this.config.interface + ' up && systemctl restart hostapd ; systemctl restart dnsmasq && ifconfig ' + this.config.interface + ' ' + hostIp + ' netmask 255.255.255.0 up && sleep 5';
            return new Promise(function (resolve, reject) {
                dnsmasq.setmode('host').then(function () {
                    exec(cmd).then(function () {
                        exec('iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination ' + hostIp + ':80 && iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to-destination ' + hostIp + ':80').then(function () {
                            resolve({ mode: 'host', ip: hostIp });
                        }).catch(function (err) {
                            verb(err, 'error', 'hostapd_switch ipfilter host switch');
                        });
                    }).catch(function (err) {
                        verb(err, 'error', 'hostapd_switch executing host switch');
                    });
                }).catch(function (err) {
                    verb(err, 'error', 'hostapd_switch executing dnsmasq host switch');
                });
            });
        };
        this.ap = function (e) {
            var dnsmasq = this.dnsmasq;
            var hostIp = dnsmasq.host;
            var cmd = 'pkill wpa_supplicant ; ifconfig ' + this.config.interface + ' up  && systemctl restart hostapd ; systemctl restart dnsmasq && ifconfig ' + this.config.interface + ' ' + hostIp + ' netmask 255.255.255.0 up && for i in $( iptables -t nat --line-numbers -L | grep ^[0-9] | awk \'{ print $1 }\' | tac ); do iptables -t nat -D PREROUTING $i; done';
            return new Promise(function (resolve, reject) {
                dnsmasq.ap().then(function () {
                    exec(cmd).then(function () {
                        resolve({ mode: 'ap', ip: hostIp });
                    }).catch(function (err) {
                        verb(err, 'error', 'hostapd_switch executing ap switch');
                    });
                }).catch(function (err) {
                    verb(err, 'error', 'hostapd_switch executing dnsmasq before ap switch');
                });
            });
        };
        this.client = function (testnetw, testint) {
            var dev = this.config.interface;
            var cmd = 'ifconfig ' + dev + ' down && sleep 2 ; pkill wpa_supplicant ;  dhclient -r ' + dev + ' ; systemctl stop hostapd ; systemctl stop dnsmasq ; sleep 2; ifconfig ' + dev + ' up && wpa_supplicant -B -i ' + dev + ' -c ' + this.config.wpasupplicant_path + ' -D wext && dhclient ' + dev + ' && for i in $( iptables -t nat --line-numbers -L | grep ^[0-9] | awk \'{ print $1 }\' | tac ); do iptables -t nat -D PREROUTING $i; done';
            return new Promise(function (resolve, reject) {
                netw().then(function (n) {
                    var todo = true;
                    var ip = false;
                    var gw = false;
                    for (var ns = 0; ns < n.networks.length; ns++) {
                        if (n.networks[ns].interface == dev && n.networks[ns].ip && n.networks[ns].gateway && n.networks[ns].gateway != '0.0.0.0') {
                            todo = false;
                            ip = n.networks[ns].ip;
                            gw = n.networks[ns].gateway;
                        }
                    }
                    if (todo) {
                        exec(cmd).then(function () {
                            if (testnetw) {
                                testconn(dev, testint).then(function (answer) {
                                    resolve(answer);
                                }).catch(function (err) {
                                    reject(err);
                                });
                            }
                            else {
                                resolve('executed');
                            }
                        }).catch(function (err) {
                            verb(err, 'warn', 'hostapd_switch exec');
                            if (testnetw) {
                                testconn(dev, testint).then(function (answer) {
                                    resolve(answer);
                                }).catch(function (err) {
                                    reject(err);
                                });
                            }
                            else {
                                resolve('executed');
                            }
                        });
                    }
                    else {
                        resolve({ mode: 'client', ip: ip, gateway: gw });
                    }
                }).catch(function (err) {
                    verb(err, 'error', 'hostapd_switch conf error');
                });
            });
        };
        merge(config, options);
        if (!pathExists.sync('/etc/default/hostapd')) {
            throw Error('no default conf file was founded for hostapd');
        }
        if (!config.hostapd.ssid) {
            throw Error('No ssid was provided');
        }
        if (!config.hostapd.wpa_passphrase) {
            throw Error('No wpa_passphrase was provided');
        }
        this.config = config;
        this.dnsmasq = new dnsmasqconf(config.dnsmasq);
        if (init) {
            hostapdconf(config.hostapd).then(function () {
                console.log('hostapd is now configured');
            });
        }
        ;
    }
    ;
    return HostapdSwitch;
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbInRlc3Rjb25uIiwiY29uc3RydWN0b3IiXSwibWFwcGluZ3MiOiJBQUNBLElBQVksT0FBTyxXQUFNLFVBQVUsQ0FBQyxDQUFBO0FBQ3BDLElBQVksVUFBVSxXQUFNLGFBQWEsQ0FBQyxDQUFBO0FBQzFDLElBQVksV0FBVyxXQUFNLGNBQWMsQ0FBQyxDQUFBO0FBQzVDLElBQU8sS0FBSyxXQUFXLFVBQVUsQ0FBQyxDQUFDO0FBQ25DLElBQU8sWUFBWSxXQUFXLHlCQUF5QixDQUFDLENBQUM7QUFDekQsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUM1QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDcEMsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBR3ZDLGtCQUFrQixDQUFTLEVBQUUsT0FBaUI7SUFFMUNBLE1BQU1BLENBQUNBLElBQUlBLE9BQU9BLENBQUNBLFVBQVNBLE9BQU9BLEVBQUVBLE1BQU1BO1FBQ3ZDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFTLENBQUM7WUFDbEIsSUFBSSxHQUFHLEdBQVEsS0FBSyxDQUFDO1lBQ3JCLElBQUksRUFBRSxHQUFRLEtBQUssQ0FBQztZQUNwQixJQUFJLElBQXNCLENBQUM7WUFDM0IsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUM7Z0JBQzVDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2hDLElBQUksR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLEVB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QUNBLENBQUNBLENBQUNBO1lBQ3ZCQSxNQUFNQSxLQUFLQSxDQUFDQSxzQkFBc0JBLENBQUNBLENBQUFBO1FBQ3ZDQSxDQUFDQTtRQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNqQ0EsTUFBTUEsS0FBS0EsQ0FBQ0EsZ0NBQWdDQSxDQUFDQSxDQUFBQTtRQUNqREEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsTUFBTUEsQ0FBQ0E7UUFFckJBLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBLElBQUlBLFdBQVdBLENBQUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1FBRS9DQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNQQSxXQUFXQSxDQUFDQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQTtnQkFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxDQUFBO1lBQzVDLENBQUMsQ0FBQ0EsQ0FBQ0E7UUFDUEEsQ0FBQ0E7UUFBQUEsQ0FBQ0E7SUFFTkEsQ0FBQ0E7O0lBZ0dMLG9CQUFDO0FBQUQsQ0F6SFMsQUF5SFIsR0FBQSxDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gXCJibHVlYmlyZFwiO1xuaW1wb3J0ICogYXMgcGF0aEV4aXN0cyBmcm9tIFwicGF0aC1leGlzdHNcIjtcbmltcG9ydCAqIGFzIGRuc21hc3Fjb25mIGZyb20gXCJkbnNtYXNxLWNvbmZcIjtcbmltcG9ydCBtZXJnZSA9IHJlcXVpcmUoXCJqc29uLWFkZFwiKTtcbmltcG9ydCB0ZXN0aW50ZXJuZXQgPSByZXF1aXJlKCdwcm9taXNlLXRlc3QtY29ubmVjdGlvbicpO1xubGV0IG5ldHcgPSByZXF1aXJlKFwibmV0d1wiKTtcbmxldCB2ZXJiID0gcmVxdWlyZSgndmVyYm8nKTtcbmxldCBleGVjID0gcmVxdWlyZSgncHJvbWlzZWQtZXhlYycpO1xubGV0IGhvc3RhcGRjb25mID0gcmVxdWlyZShcImhvc3RhcGRqc1wiKTtcblxuXG5mdW5jdGlvbiB0ZXN0Y29ubihkOiBzdHJpbmcsIHRlc3RpbnQ/OiBib29sZWFuKSB7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIG5ldHcoKS50aGVuKGZ1bmN0aW9uKG4pIHtcbiAgICAgICAgICAgIGxldCBkZXY6IGFueSA9IGZhbHNlO1xuICAgICAgICAgICAgbGV0IGlwOiBhbnkgPSBmYWxzZTtcbiAgICAgICAgICAgIGxldCBuZXR3OiB7IG1vZGU6IHN0cmluZyB9O1xuICAgICAgICAgICAgZm9yIChsZXQgbnMgPSAwOyBucyA8IG4ubmV0d29ya3MubGVuZ3RoOyBucysrKSB7XG4gICAgICAgICAgICAgICAgaWYgKG4ubmV0d29ya3NbbnNdLmludGVyZmFjZSA9PSBkKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ldHcgPSBuLm5ldHdvcmtzW25zXTtcbiAgICAgICAgICAgICAgICAgICAgZGV2ID0gZDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG4ubmV0d29ya3NbbnNdLmlwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpcCA9IG4ubmV0d29ya3NbbnNdLmlwXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICBpZiAobi5uZXR3b3Jrc1tuc10uZ2F0ZXdheSkge1xuICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgIGd3ID0gbi5uZXR3b3Jrc1tuc10uZ2F0ZXdheVxuICAgICAgICAgICAgICAgICAgICAvLyAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFkZXYpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoJ25vIGludGVyZmFjZScpXG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFpcCkge1xuICAgICAgICAgICAgICAgIHJlamVjdChkZXYgKyAnIGNhblxcJ3QgZ2V0IGFuIGlwIGFkZHJlc3MnKVxuICAgICAgICAgICAgICAgIC8vICB9IGVsc2UgaWYgKCFndykge1xuICAgICAgICAgICAgICAgIC8vICAgICByZWplY3QoZGV2ICsgJyBoYXMgbm8gZ2F0ZXdheScpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5ldHcubW9kZSA9IFwiY2xpZW50XCI7XG4gICAgICAgICAgICAgICAgaWYgKHRlc3RpbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGVzdGludGVybmV0KCkudGhlbihmdW5jdGlvbihhOiB7IGlwPzogYW55IH0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhLmlwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShuZXR3KVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG5ldHcpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIndhcm4gbm8gaW50ZXJuZXRcIilcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShuZXR3KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIHJlamVjdCgnbmV0dycgKyBlcnIpXG4gICAgICAgIH0pXG4gICAgfSlcblxufVxuXG5pbnRlcmZhY2UgSUhvc3RhcGQge1xuICAgIGludGVyZmFjZTogc3RyaW5nO1xuICAgIHNzaWQ6IHN0cmluZztcbiAgICB3cGFfcGFzc3BocmFzZTogYW55O1xufTtcblxuaW50ZXJmYWNlIElIb3N0YXBkQ2Yge1xuICAgIGludGVyZmFjZT86IHN0cmluZztcbiAgICBzc2lkPzogc3RyaW5nO1xufTtcblxuaW50ZXJmYWNlIElEbnNtYXNxIHtcbiAgICBpbnRlcmZhY2U6IHN0cmluZztcbn07XG5cbmludGVyZmFjZSBJRG5zbWFzcUNmIHtcbiAgICBpbnRlcmZhY2U/OiBzdHJpbmc7XG59O1xuXG5pbnRlcmZhY2UgSUNsYXNzT3B0IHtcbiAgICBpbnRlcmZhY2U/OiBzdHJpbmc7XG4gICAgd3Bhc3VwcGxpY2FudF9wYXRoPzogc3RyaW5nO1xuICAgIGhvc3RhcGQ/OiBJSG9zdGFwZENmO1xuICAgIHJlZGlyZWN0PzogYm9vbGVhbjtcbiAgICBkbnNtYXNxPzogSURuc21hc3FDZjtcbn07XG5cbmludGVyZmFjZSBJQ2xhc3NDb25mIHtcbiAgICBpbnRlcmZhY2U6IHN0cmluZztcbiAgICB3cGFzdXBwbGljYW50X3BhdGg6IHN0cmluZztcbiAgICBob3N0YXBkOiBJSG9zdGFwZDtcbiAgICBkbnNtYXNxOiBJRG5zbWFzcTtcbiAgICBpbml0OiBib29sZWFuO1xuICAgIHJlZGlyZWN0OiBib29sZWFuO1xufTtcblxuXG5sZXQgY29uZmlnOiBJQ2xhc3NDb25mID0ge1xuICAgIGludGVyZmFjZTogXCJ3bGFuMFwiLFxuICAgIHdwYXN1cHBsaWNhbnRfcGF0aDogXCIvZXRjL3dwYV9zdXBwbGljYW50L3dwYV9zdXBwbGljYW50LmNvbmZcIixcbiAgICByZWRpcmVjdDogdHJ1ZSxcbiAgICBob3N0YXBkOiB7IGludGVyZmFjZTogXCJ3bGFuMFwiLCB3cGFfcGFzc3BocmFzZTogZmFsc2UsIHNzaWQ6IFwiaGFwZDExMVwiIH0sXG4gICAgZG5zbWFzcTogeyBpbnRlcmZhY2U6IFwid2xhbjBcIiB9LFxuICAgIGluaXQ6IGZhbHNlXG59O1xuXG5leHBvcnQgPSBjbGFzcyBIb3N0YXBkU3dpdGNoIHtcbiAgICBjb25maWc6IElDbGFzc0NvbmY7XG4gICAgZG5zbWFzcToge307XG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogSUNsYXNzT3B0LCBpbml0PzogYm9vbGVhbikge1xuICAgICAgICBtZXJnZShjb25maWcsIG9wdGlvbnMpXG5cbiAgICAgICAgaWYgKCFwYXRoRXhpc3RzLnN5bmMoJy9ldGMvZGVmYXVsdC9ob3N0YXBkJykpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdubyBkZWZhdWx0IGNvbmYgZmlsZSB3YXMgZm91bmRlZCBmb3IgaG9zdGFwZCcpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjb25maWcuaG9zdGFwZC5zc2lkKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcignTm8gc3NpZCB3YXMgcHJvdmlkZWQnKVxuICAgICAgICB9XG4gICAgICAgIGlmICghY29uZmlnLmhvc3RhcGQud3BhX3Bhc3NwaHJhc2UpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdObyB3cGFfcGFzc3BocmFzZSB3YXMgcHJvdmlkZWQnKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG4gICAgICAgIHRoaXMuZG5zbWFzcSA9IG5ldyBkbnNtYXNxY29uZihjb25maWcuZG5zbWFzcSk7XG5cbiAgICAgICAgaWYgKGluaXQpIHtcbiAgICAgICAgICAgIGhvc3RhcGRjb25mKGNvbmZpZy5ob3N0YXBkKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdob3N0YXBkIGlzIG5vdyBjb25maWd1cmVkJylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgfTtcblxuICAgIGhvc3QgPSBmdW5jdGlvbihlPzogYW55KSB7XG4gICAgICAgIGxldCBkbnNtYXNxID0gdGhpcy5kbnNtYXNxO1xuICAgICAgICBsZXQgaG9zdElwID0gZG5zbWFzcS5ob3N0O1xuICAgICAgICBsZXQgY21kID0gJ3BraWxsIHdwYV9zdXBwbGljYW50IDsgaWZjb25maWcgJyArIHRoaXMuY29uZmlnLmludGVyZmFjZSArICcgdXAgJiYgc3lzdGVtY3RsIHJlc3RhcnQgaG9zdGFwZCA7IHN5c3RlbWN0bCByZXN0YXJ0IGRuc21hc3EgJiYgaWZjb25maWcgJyArIHRoaXMuY29uZmlnLmludGVyZmFjZSArICcgJyArIGhvc3RJcCArICcgbmV0bWFzayAyNTUuMjU1LjI1NS4wIHVwICYmIHNsZWVwIDUnO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICBkbnNtYXNxLnNldG1vZGUoJ2hvc3QnKS50aGVuKGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICAgICAgZXhlYyhjbWQpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGV4ZWMoJ2lwdGFibGVzIC10IG5hdCAtQSBQUkVST1VUSU5HIC1wIHRjcCAtLWRwb3J0IDgwIC1qIEROQVQgLS10by1kZXN0aW5hdGlvbiAnICsgaG9zdElwICsgJzo4MCAmJiBpcHRhYmxlcyAtdCBuYXQgLUEgUFJFUk9VVElORyAtcCB0Y3AgLS1kcG9ydCA0NDMgLWogRE5BVCAtLXRvLWRlc3RpbmF0aW9uICcgKyBob3N0SXAgKyAnOjgwJykudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoeyBtb2RlOiAnaG9zdCcsIGlwOiBob3N0SXAgfSlcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2ZXJiKGVyciwgJ2Vycm9yJywgJ2hvc3RhcGRfc3dpdGNoIGlwZmlsdGVyIGhvc3Qgc3dpdGNoJylcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgdmVyYihlcnIsICdlcnJvcicsICdob3N0YXBkX3N3aXRjaCBleGVjdXRpbmcgaG9zdCBzd2l0Y2gnKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICB2ZXJiKGVyciwgJ2Vycm9yJywgJ2hvc3RhcGRfc3dpdGNoIGV4ZWN1dGluZyBkbnNtYXNxIGhvc3Qgc3dpdGNoJylcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfTtcblxuXG4gICAgYXAgPSBmdW5jdGlvbihlPzogYW55KSB7XG4gICAgICAgIGxldCBkbnNtYXNxID0gdGhpcy5kbnNtYXNxO1xuICAgICAgICBsZXQgaG9zdElwID0gZG5zbWFzcS5ob3N0O1xuICAgICAgICBsZXQgY21kID0gJ3BraWxsIHdwYV9zdXBwbGljYW50IDsgaWZjb25maWcgJyArIHRoaXMuY29uZmlnLmludGVyZmFjZSArICcgdXAgICYmIHN5c3RlbWN0bCByZXN0YXJ0IGhvc3RhcGQgOyBzeXN0ZW1jdGwgcmVzdGFydCBkbnNtYXNxICYmIGlmY29uZmlnICcgKyB0aGlzLmNvbmZpZy5pbnRlcmZhY2UgKyAnICcgKyBob3N0SXAgKyAnIG5ldG1hc2sgMjU1LjI1NS4yNTUuMCB1cCAmJiBmb3IgaSBpbiAkKCBpcHRhYmxlcyAtdCBuYXQgLS1saW5lLW51bWJlcnMgLUwgfCBncmVwIF5bMC05XSB8IGF3ayBcXCd7IHByaW50ICQxIH1cXCcgfCB0YWMgKTsgZG8gaXB0YWJsZXMgLXQgbmF0IC1EIFBSRVJPVVRJTkcgJGk7IGRvbmUnXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgIGRuc21hc3EuYXAoKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGV4ZWMoY21kKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHsgbW9kZTogJ2FwJywgaXA6IGhvc3RJcCB9KVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICB2ZXJiKGVyciwgJ2Vycm9yJywgJ2hvc3RhcGRfc3dpdGNoIGV4ZWN1dGluZyBhcCBzd2l0Y2gnKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICB2ZXJiKGVyciwgJ2Vycm9yJywgJ2hvc3RhcGRfc3dpdGNoIGV4ZWN1dGluZyBkbnNtYXNxIGJlZm9yZSBhcCBzd2l0Y2gnKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9O1xuXG4gICAgY2xpZW50ID0gZnVuY3Rpb24odGVzdG5ldHc/OiBib29sZWFuLCB0ZXN0aW50PzogYm9vbGVhbikge1xuXG4gICAgICAgIGxldCBkZXYgPSB0aGlzLmNvbmZpZy5pbnRlcmZhY2U7XG4gICAgICAgIGxldCBjbWQgPSAnaWZjb25maWcgJyArIGRldiArICcgZG93biAmJiBzbGVlcCAyIDsgcGtpbGwgd3BhX3N1cHBsaWNhbnQgOyAgZGhjbGllbnQgLXIgJyArIGRldiArICcgOyBzeXN0ZW1jdGwgc3RvcCBob3N0YXBkIDsgc3lzdGVtY3RsIHN0b3AgZG5zbWFzcSA7IHNsZWVwIDI7IGlmY29uZmlnICcgKyBkZXYgKyAnIHVwICYmIHdwYV9zdXBwbGljYW50IC1CIC1pICcgKyBkZXYgKyAnIC1jICcgKyB0aGlzLmNvbmZpZy53cGFzdXBwbGljYW50X3BhdGggKyAnIC1EIHdleHQgJiYgZGhjbGllbnQgJyArIGRldiArICcgJiYgZm9yIGkgaW4gJCggaXB0YWJsZXMgLXQgbmF0IC0tbGluZS1udW1iZXJzIC1MIHwgZ3JlcCBeWzAtOV0gfCBhd2sgXFwneyBwcmludCAkMSB9XFwnIHwgdGFjICk7IGRvIGlwdGFibGVzIC10IG5hdCAtRCBQUkVST1VUSU5HICRpOyBkb25lJztcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG5cbiAgICAgICAgICAgIG5ldHcoKS50aGVuKGZ1bmN0aW9uKG4pIHtcbiAgICAgICAgICAgICAgICBsZXQgdG9kbyA9IHRydWU7XG4gICAgICAgICAgICAgICAgbGV0IGlwID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgbGV0IGd3ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgbnMgPSAwOyBucyA8IG4ubmV0d29ya3MubGVuZ3RoOyBucysrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChuLm5ldHdvcmtzW25zXS5pbnRlcmZhY2UgPT0gZGV2ICYmIG4ubmV0d29ya3NbbnNdLmlwICYmIG4ubmV0d29ya3NbbnNdLmdhdGV3YXkgJiYgbi5uZXR3b3Jrc1tuc10uZ2F0ZXdheSE9JzAuMC4wLjAnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b2RvID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBpcCA9IG4ubmV0d29ya3NbbnNdLmlwO1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3cgPSBuLm5ldHdvcmtzW25zXS5nYXRld2F5O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0b2RvKSB7XG4gICAgICAgICAgICAgICAgICAgIGV4ZWMoY21kKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RuZXR3KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGNvbm4oZGV2LCB0ZXN0aW50KS50aGVuKGZ1bmN0aW9uKGFuc3dlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGFuc3dlcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCdleGVjdXRlZCcpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmVyYihlcnIsICd3YXJuJywgJ2hvc3RhcGRfc3dpdGNoIGV4ZWMnKVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RuZXR3KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGNvbm4oZGV2LCB0ZXN0aW50KS50aGVuKGZ1bmN0aW9uKGFuc3dlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGFuc3dlcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCdleGVjdXRlZCcpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh7IG1vZGU6ICdjbGllbnQnLCBpcDogaXAsIGdhdGV3YXk6IGd3IH0pXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICB2ZXJiKGVyciwgJ2Vycm9yJywgJ2hvc3RhcGRfc3dpdGNoIGNvbmYgZXJyb3InKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgIH07XG5cblxuXG59XG5cblxuXG5cblxuXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
