"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var Promise = require("bluebird");
var pathExists = require("path-exists");
var dnsmasqconf = require("dnsmasq-conf");
var json_add_1 = require("json-add");
var promise_test_connection_1 = require('promise-test-connection');
var wpasupplicant_manager_1 = require('wpasupplicant-manager');
var netw_1 = require("netw");
var verb = require('verbo');
var exec = require('promised-exec');
var hostapdjs_1 = require("hostapdjs");
function testconn(d, testint) {
    return new Promise(function (resolve, reject) {
        netw_1.default().then(function (n) {
            var dev = false;
            var netw;
            var ip = false;
            for (var ns = 0; ns < n.length; ns++) {
                if (n[ns].interface == d) {
                    dev = d;
                    if (n[ns].ip) {
                        ip = n[ns].ip;
                    }
                }
            }
            if (!dev) {
                reject('no interface');
            }
            else if (!ip) {
                reject(dev + ' can\'t get an ip address');
            }
            else {
                if (testint) {
                    promise_test_connection_1.default().then(function (a) {
                        if (a.ip) {
                            resolve(true);
                        }
                        else {
                            resolve(true);
                        }
                    }).catch(function (err) {
                        reject(err);
                    });
                }
                else {
                    console.log("no internet test");
                    resolve(true);
                }
            }
        }).catch(function (err) {
            reject('netw' + err);
        });
    });
}
;
;
;
;
;
;
var config = {
    interface: "wlan0",
    wpasupplicant_path: "/etc/wpa_supplicant/wpa_supplicant.conf",
    redirect: true,
    hostapd: { interface: "wlan0", wpa_passphrase: false, ssid: "hapd111" },
    dnsmasq: { interface: "wlan0" },
    init: false
};
;
var HostapdSwitch = (function (_super) {
    __extends(HostapdSwitch, _super);
    function HostapdSwitch(options, init) {
        json_add_1.default(config, options);
        if (!pathExists.sync('/etc/default/hostapd')) {
            throw Error('no default conf file was founded for hostapd');
        }
        if (!config.hostapd.ssid) {
            throw Error('No ssid was provided');
        }
        if (!config.hostapd.wpa_passphrase) {
            throw Error('No wpa_passphrase was provided');
        }
        _super.call(this, config.wpasupplicant_path);
        this.config = config;
        this.dnsmasq = new dnsmasqconf(config.dnsmasq);
        if (init) {
            hostapdjs_1.default(config.hostapd).then(function () {
                console.log('hostapd is now configured');
            });
        }
        ;
    }
    ;
    HostapdSwitch.prototype.host = function (e) {
        this.mode = "host";
        var dnsmasq = this.dnsmasq;
        var hostIp = dnsmasq.hostIp;
        var cmd = 'pkill wpa_supplicant ; ifconfig ' + this.config.interface + ' up && systemctl restart hostapd ; systemctl restart dnsmasq && ifconfig ' + this.config.interface + ' ' + hostIp + ' netmask 255.255.255.0 up && sleep 5';
        return new Promise(function (resolve, reject) {
            dnsmasq.setmode('host').then(function () {
                exec(cmd).then(function () {
                    exec('iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination ' + hostIp + ':80 && iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to-destination ' + hostIp + ':80').then(function () {
                        resolve(true);
                    }).catch(function (err) {
                        verb(err, 'error', 'hostapd_switch ipfilter host switch');
                    });
                }).catch(function (err) {
                    verb(err, 'error', 'hostapd_switch executing host switch');
                });
            }).catch(function (err) {
                verb(err, 'error', 'hostapd_switch executing dnsmasq host switch');
            });
        });
    };
    ;
    HostapdSwitch.prototype.ap = function (e) {
        this.mode = "ap";
        var dnsmasq = this.dnsmasq;
        var hostIp = dnsmasq.hostIp;
        var cmd = 'pkill wpa_supplicant ; ifconfig ' + this.config.interface + ' up  && systemctl restart hostapd ; systemctl restart dnsmasq && ifconfig ' + this.config.interface + ' ' + hostIp + ' netmask 255.255.255.0 up && for i in $( iptables -t nat --line-numbers -L | grep ^[0-9] | awk \'{ print $1 }\' | tac ); do iptables -t nat -D PREROUTING $i; done';
        return new Promise(function (resolve, reject) {
            dnsmasq.ap().then(function () {
                exec(cmd).then(function () {
                    resolve(true);
                }).catch(function (err) {
                    verb(err, 'error', 'hostapd_switch executing ap switch');
                });
            }).catch(function (err) {
                verb(err, 'error', 'hostapd_switch executing dnsmasq before ap switch');
            });
        });
    };
    ;
    HostapdSwitch.prototype.client = function (testnetw, testint) {
        this.mode = "client";
        var dev = this.config.interface;
        var driver;
        if (this.config.hostapd.driver === 'nl80211') {
            driver = 'nl80211';
        }
        else {
            driver = 'wext';
        }
        var cmd = 'ifconfig ' + dev + ' down && sleep 2 ; pkill wpa_supplicant ;  dhclient -r ' + dev + ' ; systemctl stop hostapd ; systemctl stop dnsmasq ; sleep 2; ifconfig ' + dev + ' up && wpa_supplicant -B -i ' + dev + ' -c ' + this.config.wpasupplicant_path + ' -D ' + driver + ' && dhclient ' + dev + ' && for i in $( iptables -t nat --line-numbers -L | grep ^[0-9] | awk \'{ print $1 }\' | tac ); do iptables -t nat -D PREROUTING $i; done; sleep 10';
        return new Promise(function (resolve, reject) {
            exec(cmd).then(function () {
                if (testnetw) {
                    testconn(dev, testint).then(function (answer) {
                        resolve(answer);
                    }).catch(function (err) {
                        reject(err);
                    });
                }
                else {
                    resolve(true);
                }
            }).catch(function (err) {
                verb(err, 'warn', 'hostapd_switch exec');
                if (testnetw) {
                    testconn(dev, testint).then(function (answer) {
                        resolve(answer);
                    }).catch(function (err) {
                        reject(err);
                    });
                }
                else {
                    resolve(true);
                }
            });
        });
    };
    ;
    return HostapdSwitch;
}(wpasupplicant_manager_1.default));
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = HostapdSwitch;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLElBQVksT0FBTyxXQUFNLFVBQVUsQ0FBQyxDQUFBO0FBQ3BDLElBQVksVUFBVSxXQUFNLGFBQWEsQ0FBQyxDQUFBO0FBQzFDLElBQVksV0FBVyxXQUFNLGNBQWMsQ0FBQyxDQUFBO0FBQzVDLHlCQUFrQixVQUFVLENBQUMsQ0FBQTtBQUM3Qix3Q0FBeUIseUJBQXlCLENBQUMsQ0FBQTtBQUNuRCxzQ0FBdUIsdUJBQXdCLENBQUMsQ0FBQTtBQUVoRCxxQkFBaUIsTUFBTSxDQUFDLENBQUE7QUFDeEIsSUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzlCLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUN0QywwQkFBd0IsV0FBVyxDQUFDLENBQUE7QUFrQnBDLGtCQUFrQixDQUFTLEVBQUUsT0FBaUI7SUFFMUMsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFVLFVBQVUsT0FBTyxFQUFFLE1BQU07UUFDakQsY0FBSSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBWTtZQUM5QixJQUFJLEdBQUcsR0FBUSxLQUFLLENBQUM7WUFDckIsSUFBSSxJQUFhLENBQUM7WUFDbEIsSUFBSSxFQUFFLEdBQVEsS0FBSyxDQUFDO1lBSXBCLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDO2dCQUNuQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBR3ZCLEdBQUcsR0FBRyxDQUFDLENBQUM7b0JBQ1IsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7d0JBQ1gsRUFBRSxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUE7b0JBQ2pCLENBQUM7Z0JBSUwsQ0FBQztZQUNMLENBQUM7WUFDRCxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ1AsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQzNCLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNiLE1BQU0sQ0FBQyxHQUFHLEdBQUcsMkJBQTJCLENBQUMsQ0FBQztZQUc5QyxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBR0osRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztvQkFDVixpQ0FBWSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBZTt3QkFDekMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7NEJBQ1AsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO3dCQUNsQixDQUFDO3dCQUFDLElBQUksQ0FBQyxDQUFDOzRCQUNKLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDbEIsQ0FBQztvQkFDTCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHO3dCQUNsQixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2hCLENBQUMsQ0FBQyxDQUFBO2dCQUNOLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ0osT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO29CQUNoQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2xCLENBQUM7WUFDTCxDQUFDO1FBRUwsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRztZQUNsQixNQUFNLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQyxDQUFDLENBQUE7QUFFTixDQUFDO0FBT0EsQ0FBQztBQU1ELENBQUM7QUFJRCxDQUFDO0FBSUQsQ0FBQztBQVFELENBQUM7QUFTRCxDQUFDO0FBR0YsSUFBSSxNQUFNLEdBQWU7SUFDckIsU0FBUyxFQUFFLE9BQU87SUFDbEIsa0JBQWtCLEVBQUUseUNBQXlDO0lBQzdELFFBQVEsRUFBRSxJQUFJO0lBQ2QsT0FBTyxFQUFFLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUU7SUFDdkUsT0FBTyxFQUFFLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRTtJQUMvQixJQUFJLEVBQUUsS0FBSztDQUNkLENBQUM7QUFNRCxDQUFDO0FBc0NGO0lBQTJDLGlDQUFVO0lBSWpELHVCQUFZLE9BQWtCLEVBQUUsSUFBYztRQUMxQyxrQkFBSyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUV0QixFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0MsTUFBTSxLQUFLLENBQUMsOENBQThDLENBQUMsQ0FBQTtRQUMvRCxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDdkIsTUFBTSxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtRQUN2QyxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7WUFDakMsTUFBTSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQTtRQUNqRCxDQUFDO1FBRUQsa0JBQU0sTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUE7UUFHaEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLFdBQVcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFL0MsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNQLG1CQUFXLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxDQUFBO1lBQzVDLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztRQUFBLENBQUM7SUFFTixDQUFDOztJQUVELDRCQUFJLEdBQUosVUFBSyxDQUFPO1FBQ1IsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUM7UUFDbkIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUMzQixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQzVCLElBQUksR0FBRyxHQUFHLGtDQUFrQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxHQUFHLDJFQUEyRSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxHQUFHLEdBQUcsR0FBRyxNQUFNLEdBQUcsc0NBQXNDLENBQUM7UUFDbk8sTUFBTSxDQUFDLElBQUksT0FBTyxDQUFVLFVBQVUsT0FBTyxFQUFFLE1BQU07WUFDakQsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBRXpCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7b0JBQ1gsSUFBSSxDQUFDLDJFQUEyRSxHQUFHLE1BQU0sR0FBRyxtRkFBbUYsR0FBRyxNQUFNLEdBQUcsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDO3dCQUNuTSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7b0JBQ2pCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUc7d0JBQ2xCLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLHFDQUFxQyxDQUFDLENBQUE7b0JBQzdELENBQUMsQ0FBQyxDQUFBO2dCQUNOLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUc7b0JBQ2xCLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLHNDQUFzQyxDQUFDLENBQUE7Z0JBQzlELENBQUMsQ0FBQyxDQUFBO1lBQ04sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRztnQkFDbEIsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsOENBQThDLENBQUMsQ0FBQTtZQUN0RSxDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQzs7SUFHRCwwQkFBRSxHQUFGLFVBQUcsQ0FBTztRQUNOLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDM0IsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUM1QixJQUFJLEdBQUcsR0FBRyxrQ0FBa0MsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyw0RUFBNEUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxHQUFHLEdBQUcsTUFBTSxHQUFHLG9LQUFvSyxDQUFBO1FBQ2pXLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBVSxVQUFVLE9BQU8sRUFBRSxNQUFNO1lBQ2pELE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUM7Z0JBQ2QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztvQkFDWCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7Z0JBQ2pCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUc7b0JBQ2xCLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLG9DQUFvQyxDQUFDLENBQUE7Z0JBQzVELENBQUMsQ0FBQyxDQUFBO1lBQ04sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRztnQkFDbEIsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsbURBQW1ELENBQUMsQ0FBQTtZQUMzRSxDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQzs7SUFFRCw4QkFBTSxHQUFOLFVBQU8sUUFBa0IsRUFBRSxPQUFpQjtRQUN4QyxJQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQztRQUNyQixJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztRQUNsQyxJQUFJLE1BQWMsQ0FBQztRQUNuQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUMzQyxNQUFNLEdBQUcsU0FBUyxDQUFDO1FBQ3ZCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDcEIsQ0FBQztRQUNELElBQUksR0FBRyxHQUFHLFdBQVcsR0FBRyxHQUFHLEdBQUcseURBQXlELEdBQUcsR0FBRyxHQUFHLHlFQUF5RSxHQUFHLEdBQUcsR0FBRyw4QkFBOEIsR0FBRyxHQUFHLEdBQUcsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxHQUFHLE1BQU0sR0FBRyxlQUFlLEdBQUcsR0FBRyxHQUFHLHFKQUFxSixDQUFDO1FBRW5jLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBVSxVQUFVLE9BQU8sRUFBRSxNQUFNO1lBRWpELElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ1gsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztvQkFDWCxRQUFRLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLE1BQU07d0JBQ3hDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtvQkFDbkIsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRzt3QkFDbEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO29CQUNmLENBQUMsQ0FBQyxDQUFBO2dCQUNOLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ0osT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO2dCQUNqQixDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRztnQkFDbEIsSUFBSSxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUscUJBQXFCLENBQUMsQ0FBQTtnQkFDeEMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztvQkFDWCxRQUFRLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLE1BQU07d0JBQ3hDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtvQkFDbkIsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRzt3QkFDbEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO29CQUNmLENBQUMsQ0FBQyxDQUFBO2dCQUNOLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ0osT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO2dCQUNqQixDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUE7UUFHTixDQUFDLENBQUMsQ0FBQTtJQUVOLENBQUM7O0lBSUwsb0JBQUM7QUFBRCxDQXJIQSxBQXFIQyxDQXJIMEMsK0JBQVUsR0FxSHBEO0FBckhEOytCQXFIQyxDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gXCJibHVlYmlyZFwiO1xuaW1wb3J0ICogYXMgcGF0aEV4aXN0cyBmcm9tIFwicGF0aC1leGlzdHNcIjtcbmltcG9ydCAqIGFzIGRuc21hc3Fjb25mIGZyb20gXCJkbnNtYXNxLWNvbmZcIjtcbmltcG9ydCBtZXJnZSBmcm9tIFwianNvbi1hZGRcIjtcbmltcG9ydCB0ZXN0aW50ZXJuZXQgZnJvbSAncHJvbWlzZS10ZXN0LWNvbm5lY3Rpb24nO1xuaW1wb3J0IHdwYW1hbmFnZXIgZnJvbSAnd3Bhc3VwcGxpY2FudC1tYW5hZ2VyJyA7XG5cbmltcG9ydCBuZXR3IGZyb20gXCJuZXR3XCI7XG5jb25zdCB2ZXJiID0gcmVxdWlyZSgndmVyYm8nKTtcbmNvbnN0IGV4ZWMgPSByZXF1aXJlKCdwcm9taXNlZC1leGVjJyk7XG5pbXBvcnQgaG9zdGFwZGNvbmYgZnJvbSBcImhvc3RhcGRqc1wiO1xuaW50ZXJmYWNlIFNjYW4ge1xuICAgIGVzc2lkOiBzdHJpbmc7XG4gICAgbWFjOiBzdHJpbmc7XG4gICAgc2lnbmFsOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBOZXR3b3JrIHtcbiAgICB0eXBlOiBzdHJpbmc7XG4gICAgbWFjOiBzdHJpbmc7XG4gICAgaW50ZXJmYWNlOiBzdHJpbmc7XG4gICAgZXNzaWQ/OiBzdHJpbmc7XG4gICAgc2Nhbj86IFNjYW5bXTtcbiAgICBpcD86IHN0cmluZztcbiAgICBnYXRld2F5Pzogc3RyaW5nO1xufVxuXG5cbmZ1bmN0aW9uIHRlc3Rjb25uKGQ6IHN0cmluZywgdGVzdGludD86IGJvb2xlYW4pIHtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxib29sZWFuPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIG5ldHcoKS50aGVuKGZ1bmN0aW9uIChuOiBOZXR3b3JrW10pIHtcbiAgICAgICAgICAgIGxldCBkZXY6IGFueSA9IGZhbHNlO1xuICAgICAgICAgICAgbGV0IG5ldHc6IE5ldHdvcms7XG4gICAgICAgICAgICBsZXQgaXA6IGFueSA9IGZhbHNlO1xuXG5cblxuICAgICAgICAgICAgZm9yIChsZXQgbnMgPSAwOyBucyA8IG4ubGVuZ3RoOyBucysrKSB7XG4gICAgICAgICAgICAgICAgaWYgKG5bbnNdLmludGVyZmFjZSA9PSBkKSB7XG5cblxuICAgICAgICAgICAgICAgICAgICBkZXYgPSBkO1xuICAgICAgICAgICAgICAgICAgICBpZiAobltuc10uaXApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlwID0gbltuc10uaXBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgIGlmIChuLm5ldHdvcmtzW25zXS5nYXRld2F5KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vICAgICAgICAgZ3cgPSBuLm5ldHdvcmtzW25zXS5nYXRld2F5XG4gICAgICAgICAgICAgICAgICAgIC8vICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWRldikge1xuICAgICAgICAgICAgICAgIHJlamVjdCgnbm8gaW50ZXJmYWNlJyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFpcCkge1xuICAgICAgICAgICAgICAgIHJlamVjdChkZXYgKyAnIGNhblxcJ3QgZ2V0IGFuIGlwIGFkZHJlc3MnKTtcbiAgICAgICAgICAgICAgICAvLyAgfSBlbHNlIGlmICghZ3cpIHtcbiAgICAgICAgICAgICAgICAvLyAgICAgcmVqZWN0KGRldiArICcgaGFzIG5vIGdhdGV3YXknKVxuICAgICAgICAgICAgfSBlbHNlIHtcblxuXG4gICAgICAgICAgICAgICAgaWYgKHRlc3RpbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGVzdGludGVybmV0KCkudGhlbihmdW5jdGlvbiAoYTogeyBpcD86IGFueSB9KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYS5pcCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibm8gaW50ZXJuZXQgdGVzdFwiKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgcmVqZWN0KCduZXR3JyArIGVycik7XG4gICAgICAgIH0pXG4gICAgfSlcblxufVxuXG5pbnRlcmZhY2UgSUhvc3RhcGQge1xuICAgIGludGVyZmFjZTogc3RyaW5nO1xuICAgIHNzaWQ6IHN0cmluZztcbiAgICB3cGFfcGFzc3BocmFzZTogYW55O1xuICAgIGRyaXZlcj86IHN0cmluZztcbn07XG5cbmludGVyZmFjZSBJSG9zdGFwZENmIHtcbiAgICBkcml2ZXI/OiBzdHJpbmc7XG4gICAgc3NpZD86IHN0cmluZztcbiAgICB3cGFfcGFzc3BocmFzZT86IHN0cmluZztcbn07XG5cbmludGVyZmFjZSBJRG5zbWFzcSB7XG4gICAgaW50ZXJmYWNlOiBzdHJpbmc7XG59O1xuXG5pbnRlcmZhY2UgSURuc21hc3FDZiB7XG4gICAgaW50ZXJmYWNlPzogc3RyaW5nO1xufTtcblxuaW50ZXJmYWNlIElDbGFzc09wdCB7XG4gICAgaW50ZXJmYWNlPzogc3RyaW5nO1xuICAgIHdwYXN1cHBsaWNhbnRfcGF0aD86IHN0cmluZztcbiAgICBob3N0YXBkPzogSUhvc3RhcGRDZjtcbiAgICByZWRpcmVjdD86IGJvb2xlYW47XG4gICAgZG5zbWFzcT86IElEbnNtYXNxQ2Y7XG59O1xuXG5pbnRlcmZhY2UgSUNsYXNzQ29uZiB7XG4gICAgaW50ZXJmYWNlOiBzdHJpbmc7XG4gICAgd3Bhc3VwcGxpY2FudF9wYXRoOiBzdHJpbmc7XG4gICAgaG9zdGFwZDogSUhvc3RhcGQ7XG4gICAgZG5zbWFzcTogSURuc21hc3E7XG4gICAgaW5pdDogYm9vbGVhbjtcbiAgICByZWRpcmVjdDogYm9vbGVhbjtcbn07XG5cblxubGV0IGNvbmZpZzogSUNsYXNzQ29uZiA9IHtcbiAgICBpbnRlcmZhY2U6IFwid2xhbjBcIixcbiAgICB3cGFzdXBwbGljYW50X3BhdGg6IFwiL2V0Yy93cGFfc3VwcGxpY2FudC93cGFfc3VwcGxpY2FudC5jb25mXCIsXG4gICAgcmVkaXJlY3Q6IHRydWUsXG4gICAgaG9zdGFwZDogeyBpbnRlcmZhY2U6IFwid2xhbjBcIiwgd3BhX3Bhc3NwaHJhc2U6IGZhbHNlLCBzc2lkOiBcImhhcGQxMTFcIiB9LFxuICAgIGRuc21hc3E6IHsgaW50ZXJmYWNlOiBcIndsYW4wXCIgfSxcbiAgICBpbml0OiBmYWxzZVxufTtcblxuaW50ZXJmYWNlIElEbnNNb2RlcyB7XG4gICAgYXA6IElEbnNNb2RlO1xuICAgIGxpbms6IElEbnNNb2RlO1xuICAgIGhvc3Q6IElEbnNNb2RlXG59O1xuXG5pbnRlcmZhY2UgSURuc01vZGUge1xuICAgIG5vcmVzb2x2OiBib29sZWFuLFxuICAgIGRuczogW3N0cmluZ10sXG4gICAgZGhjcDoge1xuICAgICAgICBzdG9wOiBudW1iZXI7XG4gICAgICAgIHN0YXJ0OiBudW1iZXI7XG4gICAgICAgIGxlYXNlOiBzdHJpbmc7XG4gICAgfTtcbiAgICBob3N0SXA6IHN0cmluZyxcbiAgICB0ZXN0OiBib29sZWFuLFxuICAgIGludGVyZmFjZTogYW55LFxuICAgIGFkZHJlc3M/OiBzdHJpbmdcbn1cblxuXG5cbmludGVyZmFjZSBJRG5zIHtcbiAgICBtb2RlczogSURuc01vZGVzO1xuICAgIG1vZGU/OiBzdHJpbmc7XG4gICAgcGF0aDogc3RyaW5nO1xuICAgIGludGVyZmFjZTogYW55O1xuICAgIHRlc3Q6IGJvb2xlYW47XG4gICAgZGhjcDoge1xuICAgICAgICBzdG9wOiBudW1iZXI7XG4gICAgICAgIHN0YXJ0OiBudW1iZXI7XG4gICAgICAgIGxlYXNlOiBzdHJpbmc7XG4gICAgfTtcbiAgICBkbnM6IFtzdHJpbmddO1xuICAgIGhvc3RJcDogc3RyaW5nO1xuICAgIGFwOiBGdW5jdGlvbjtcbiAgICBob3N0OiBGdW5jdGlvbjtcbiAgICBsaW5rOiBGdW5jdGlvbjtcbiAgICBzZXRtb2RlKHN0cmluZyk7XG59XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSG9zdGFwZFN3aXRjaCBleHRlbmRzIHdwYW1hbmFnZXIge1xuICAgIGNvbmZpZzogSUNsYXNzQ29uZjtcbiAgICBkbnNtYXNxOiBJRG5zO1xuICAgIG1vZGU6IHN0cmluZztcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiBJQ2xhc3NPcHQsIGluaXQ/OiBib29sZWFuKSB7XG4gICAgICAgIG1lcmdlKGNvbmZpZywgb3B0aW9ucylcblxuICAgICAgICBpZiAoIXBhdGhFeGlzdHMuc3luYygnL2V0Yy9kZWZhdWx0L2hvc3RhcGQnKSkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ25vIGRlZmF1bHQgY29uZiBmaWxlIHdhcyBmb3VuZGVkIGZvciBob3N0YXBkJylcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWNvbmZpZy5ob3N0YXBkLnNzaWQpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdObyBzc2lkIHdhcyBwcm92aWRlZCcpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjb25maWcuaG9zdGFwZC53cGFfcGFzc3BocmFzZSkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ05vIHdwYV9wYXNzcGhyYXNlIHdhcyBwcm92aWRlZCcpXG4gICAgICAgIH1cblxuICAgICAgICBzdXBlcihjb25maWcud3Bhc3VwcGxpY2FudF9wYXRoKVxuXG5cbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG5cbiAgICAgICAgdGhpcy5kbnNtYXNxID0gbmV3IGRuc21hc3Fjb25mKGNvbmZpZy5kbnNtYXNxKTtcblxuICAgICAgICBpZiAoaW5pdCkge1xuICAgICAgICAgICAgaG9zdGFwZGNvbmYoY29uZmlnLmhvc3RhcGQpLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdob3N0YXBkIGlzIG5vdyBjb25maWd1cmVkJylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgfTtcblxuICAgIGhvc3QoZT86IGFueSkge1xuICAgICAgICB0aGlzLm1vZGUgPSBcImhvc3RcIjtcbiAgICAgICAgbGV0IGRuc21hc3EgPSB0aGlzLmRuc21hc3E7XG4gICAgICAgIGxldCBob3N0SXAgPSBkbnNtYXNxLmhvc3RJcDtcbiAgICAgICAgbGV0IGNtZCA9ICdwa2lsbCB3cGFfc3VwcGxpY2FudCA7IGlmY29uZmlnICcgKyB0aGlzLmNvbmZpZy5pbnRlcmZhY2UgKyAnIHVwICYmIHN5c3RlbWN0bCByZXN0YXJ0IGhvc3RhcGQgOyBzeXN0ZW1jdGwgcmVzdGFydCBkbnNtYXNxICYmIGlmY29uZmlnICcgKyB0aGlzLmNvbmZpZy5pbnRlcmZhY2UgKyAnICcgKyBob3N0SXAgKyAnIG5ldG1hc2sgMjU1LjI1NS4yNTUuMCB1cCAmJiBzbGVlcCA1JztcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgIGRuc21hc3Euc2V0bW9kZSgnaG9zdCcpLnRoZW4oZnVuY3Rpb24gKCkge1xuXG4gICAgICAgICAgICAgICAgZXhlYyhjbWQpLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBleGVjKCdpcHRhYmxlcyAtdCBuYXQgLUEgUFJFUk9VVElORyAtcCB0Y3AgLS1kcG9ydCA4MCAtaiBETkFUIC0tdG8tZGVzdGluYXRpb24gJyArIGhvc3RJcCArICc6ODAgJiYgaXB0YWJsZXMgLXQgbmF0IC1BIFBSRVJPVVRJTkcgLXAgdGNwIC0tZHBvcnQgNDQzIC1qIEROQVQgLS10by1kZXN0aW5hdGlvbiAnICsgaG9zdElwICsgJzo4MCcpLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKVxuICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2ZXJiKGVyciwgJ2Vycm9yJywgJ2hvc3RhcGRfc3dpdGNoIGlwZmlsdGVyIGhvc3Qgc3dpdGNoJylcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHZlcmIoZXJyLCAnZXJyb3InLCAnaG9zdGFwZF9zd2l0Y2ggZXhlY3V0aW5nIGhvc3Qgc3dpdGNoJylcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgIHZlcmIoZXJyLCAnZXJyb3InLCAnaG9zdGFwZF9zd2l0Y2ggZXhlY3V0aW5nIGRuc21hc3EgaG9zdCBzd2l0Y2gnKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9O1xuXG5cbiAgICBhcChlPzogYW55KSB7XG4gICAgICAgIHRoaXMubW9kZSA9IFwiYXBcIjtcbiAgICAgICAgbGV0IGRuc21hc3EgPSB0aGlzLmRuc21hc3E7XG4gICAgICAgIGxldCBob3N0SXAgPSBkbnNtYXNxLmhvc3RJcDtcbiAgICAgICAgbGV0IGNtZCA9ICdwa2lsbCB3cGFfc3VwcGxpY2FudCA7IGlmY29uZmlnICcgKyB0aGlzLmNvbmZpZy5pbnRlcmZhY2UgKyAnIHVwICAmJiBzeXN0ZW1jdGwgcmVzdGFydCBob3N0YXBkIDsgc3lzdGVtY3RsIHJlc3RhcnQgZG5zbWFzcSAmJiBpZmNvbmZpZyAnICsgdGhpcy5jb25maWcuaW50ZXJmYWNlICsgJyAnICsgaG9zdElwICsgJyBuZXRtYXNrIDI1NS4yNTUuMjU1LjAgdXAgJiYgZm9yIGkgaW4gJCggaXB0YWJsZXMgLXQgbmF0IC0tbGluZS1udW1iZXJzIC1MIHwgZ3JlcCBeWzAtOV0gfCBhd2sgXFwneyBwcmludCAkMSB9XFwnIHwgdGFjICk7IGRvIGlwdGFibGVzIC10IG5hdCAtRCBQUkVST1VUSU5HICRpOyBkb25lJ1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8Ym9vbGVhbj4oZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgZG5zbWFzcS5hcCgpLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGV4ZWMoY21kKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgdmVyYihlcnIsICdlcnJvcicsICdob3N0YXBkX3N3aXRjaCBleGVjdXRpbmcgYXAgc3dpdGNoJylcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgIHZlcmIoZXJyLCAnZXJyb3InLCAnaG9zdGFwZF9zd2l0Y2ggZXhlY3V0aW5nIGRuc21hc3EgYmVmb3JlIGFwIHN3aXRjaCcpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgIH07XG5cbiAgICBjbGllbnQodGVzdG5ldHc/OiBib29sZWFuLCB0ZXN0aW50PzogYm9vbGVhbikge1xuICAgICAgICB0aGlzLm1vZGUgPSBcImNsaWVudFwiO1xuICAgICAgICBjb25zdCBkZXYgPSB0aGlzLmNvbmZpZy5pbnRlcmZhY2U7XG4gICAgICAgIGxldCBkcml2ZXI6IHN0cmluZztcbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLmhvc3RhcGQuZHJpdmVyID09PSAnbmw4MDIxMScpIHtcbiAgICAgICAgICAgIGRyaXZlciA9ICdubDgwMjExJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRyaXZlciA9ICd3ZXh0JztcbiAgICAgICAgfVxuICAgICAgICBsZXQgY21kID0gJ2lmY29uZmlnICcgKyBkZXYgKyAnIGRvd24gJiYgc2xlZXAgMiA7IHBraWxsIHdwYV9zdXBwbGljYW50IDsgIGRoY2xpZW50IC1yICcgKyBkZXYgKyAnIDsgc3lzdGVtY3RsIHN0b3AgaG9zdGFwZCA7IHN5c3RlbWN0bCBzdG9wIGRuc21hc3EgOyBzbGVlcCAyOyBpZmNvbmZpZyAnICsgZGV2ICsgJyB1cCAmJiB3cGFfc3VwcGxpY2FudCAtQiAtaSAnICsgZGV2ICsgJyAtYyAnICsgdGhpcy5jb25maWcud3Bhc3VwcGxpY2FudF9wYXRoICsgJyAtRCAnICsgZHJpdmVyICsgJyAmJiBkaGNsaWVudCAnICsgZGV2ICsgJyAmJiBmb3IgaSBpbiAkKCBpcHRhYmxlcyAtdCBuYXQgLS1saW5lLW51bWJlcnMgLUwgfCBncmVwIF5bMC05XSB8IGF3ayBcXCd7IHByaW50ICQxIH1cXCcgfCB0YWMgKTsgZG8gaXB0YWJsZXMgLXQgbmF0IC1EIFBSRVJPVVRJTkcgJGk7IGRvbmU7IHNsZWVwIDEwJztcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8Ym9vbGVhbj4oZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuXG4gICAgICAgICAgICBleGVjKGNtZCkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRlc3RuZXR3KSB7XG4gICAgICAgICAgICAgICAgICAgIHRlc3Rjb25uKGRldiwgdGVzdGludCkudGhlbihmdW5jdGlvbiAoYW5zd2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGFuc3dlcilcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgIHZlcmIoZXJyLCAnd2FybicsICdob3N0YXBkX3N3aXRjaCBleGVjJylcbiAgICAgICAgICAgICAgICBpZiAodGVzdG5ldHcpIHtcbiAgICAgICAgICAgICAgICAgICAgdGVzdGNvbm4oZGV2LCB0ZXN0aW50KS50aGVuKGZ1bmN0aW9uIChhbnN3ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYW5zd2VyKVxuICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuXG5cbiAgICAgICAgfSlcblxuICAgIH07XG5cblxuXG59XG5cblxuXG5cblxuXG4iXX0=
